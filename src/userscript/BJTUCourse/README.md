# BJTU 抢课脚本

**免责声明: 此脚本仅供学习交流使用, 请于下载后的 24 小时内删除, 禁止用于实际选课, 由使用此脚本造成的任何后果与开发者无关**

1. 为浏览器安装`Tampermonkey`拓展
2. 安装`userscript.user.js`
3. 在选课界面/脚本代码页面写入匹配规则
4. 点击`开始抢课`, 等待抢课成功通知

**按下 F12 打开控制台查看抢课日志**

## 🔰 使用说明

### 🎨 匹配模式:

- 简单匹配 (`config.simpleMatchPatterns`)
  - 支持匹配课程名, 支持泛选
  - 支持直接在选课界面设置, 课程名之间用英文逗号`,`分隔
- 高级匹配 (`config.advanceMatchPatterns`)
  - 支持匹配表格内的部分字段
  - 不支持在选课界面内设置, 请手动编辑脚本中的变量值

### 📫 结果推送

当抢课成功时, 脚本将通过以下途径通知:

- 系统通知弹出提示
- 浏览器控制台相应日志输出
- 支持将结果通过[PushPlus](http://www.pushplus.plus/)推送到微信
  - 使用前需申请`token`并填入`config.pushPlusToken`

## 🎯 匹配模式示例

### 📌 简单匹配示例

要匹配`人类的生育与健康 02`与`癌症知多少`

```js
simpleMatchPatterns: ['人类的生育与健康 02', '癌症知多少']
```

### 📌 高级匹配示例

> 高级匹配不支持在选课界面内设置, 请手动编辑脚本中的变量值

要匹配`晓明明`老师的`修身养性与大学生活`

```js
advanceMatchPatterns: [{ cname: '修身养性与大学生活', tname: '晓明明' }]
```

要匹配`星期二 第2节`的`神奇的基因`、`星期日`的`生命科学纵横`

```js
advanceMatchPatterns: [
  { cname: '神奇的基因', tap: '星期二 第2节' },
  { cname: '生命科学纵横', tap: '星期日' }
]
```

要抛出`中国历史文化概论 01`并匹配`中国历史文化概论 02`

```js
advanceMatchPatterns: [{ cname: '中国历史文化概论 02', throw: '中国历史文化概论 01' }]
```

支持参数:

- `cname` (课程名)
- `credit` (学分)
- `type` (考试类型)
- `tname` (上课教师)
- `tap` (时间地点)
- `more` (选课限制说明)
- `throw` (要抛出的课程名)

## 🚀 进阶用法

如果上述内容无法满足你的需求, 可以阅读此节, 了解脚本的进阶用法.

### 🔎 利用`advanceQuery`提高检索速度

可以为`config.advanceQuery`传入查询字符串, 将需要检索的课程量降低, 从而在一定程度上提高检索速度.

同时, 可以利用此属性减少需要设定的匹配参数: 例如, 只希望脚本检索所有的人文与艺术类课程, 可以为此属性传入`&gname2019=2`这样脚本取到的源数据将只有这类课程, 在此基础上设置的匹配规则可以更加简单.

### 🧲 利用`throw`属性实现抛-抢联动

> 匹配到目标课程因已选同类课而无法选择时, 抛出已有的课程, 选择目标课程

在高级匹配模式下, 当匹配到课程时, 脚本通过`throw`的值检查已选中的课堂课表, 如有则先抛出`throw`值代表的课程, 随后在下一轮检索时发出网络请求, 抢由其他属性匹配到的课程.

**注意, 在应用`throw`属性时, 请务必确保其他属性的值能让脚本唯一匹配你希望抢的那一门课, 而不是能匹配到其他同类课程**

**注意, 由于选课是在下一轮检索进行的, 所以请避免设置较低的频率以免课程被抢**

> `cname`的完整的格式为[课程号:课程名 课序号]

## 💡 脚本原理

用`fetch()`请求纯净的`<table>`元素, 使用 tabletojson 库将其转为 json, 用`setInterval()`无刷新定时重新获取最新数据, 用`isMatched()`匹配给定表达式, 一旦匹配成功触发`trialSubmit()`, 根据实际情况选择重新请求数据还是提交选课请求.

简单匹配与高级匹配`pattern`上的区别在调用`addMatchTask()`时被抹平, 由`toAdvancePattern()`将简单匹配的格式转为了包含`cname`属性的高级匹配格式.

针对`throw`属性, 它仅仅用于标识要抛出课程的`cname`, 在课程抛出后通过调用`modifyTask()`将其转为了不包含`throw`的高级匹配任务.

## 😳 注意事项

读取参数优先级: `config.simpleMatchPatterns` > `界面输入(本地存储)`

使用参数优先级: `config.advanceMatchPatterns` > `config.simpleMatchPatterns`
